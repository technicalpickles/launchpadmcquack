#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), "..", "lib")
require "launchpad_mcquack"
require "unimidi"

require "eventmachine"

# ugh hard-coded. coremidi doesn't seem to distinguish between different ports
@output = UniMIDI::Output.all[3]

@launchpad = Launchpad.setup(output: @output)
@launchpad.off

bpm = 160
period_in_seconds = 60 / bpm.to_f

puts "#{bpm} bpm, #{period_in_seconds} interval"
EventMachine.run {
  trap("SIGINT") {
    EventMachine.stop_event_loop
  }

  EventMachine.add_shutdown_hook do
    @launchpad.off
  end

  @tick_timer = EventMachine.add_periodic_timer(period_in_seconds) do
    @launchpad.tick
  end

  @note_timer = EventMachine.add_periodic_timer(0.02) {
    @launchpad.handle_presses
  }
}
